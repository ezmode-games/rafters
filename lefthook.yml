# Pre-commit hook: Fast checks (target <30s)
pre-commit:
  parallel: true
  commands:
    lint:
      glob: "*.{ts,tsx,js,jsx,json}"
      run: pnpm biome check --write {staged_files} || [ $? -eq 1 ]
      stage_fixed: true
    typecheck:
      glob: "*.{ts,tsx}"
      run: pnpm typecheck
    unit-tests:
      glob: "*.{ts,tsx}"
      run: |
        packages=$(echo "{staged_files}" | tr ' ' '\n' | \
          grep -E '^(apps|packages)/' | \
          sed 's|^\(apps/[^/]*\).*|\1|; s|^\(packages/[^/]*\).*|\1|' | \
          sort -u)

        if [ -z "$packages" ]; then
          echo "No workspace packages changed"
          exit 0
        fi

        echo "Testing packages:"
        echo "$packages" | sed 's/^/  - /'

        for pkg_path in $packages; do
          pkg_name=$(grep -oP '"name":\s*"\K[^"]+' "$pkg_path/package.json" 2>/dev/null)
          if [ -n "$pkg_name" ]; then
            echo "Running tests for $pkg_name..."
            pnpm --filter "$pkg_name" test:unit --run || exit 1
          fi
        done

# Pre-push hook: Full validation (target <5min)
pre-push:
  parallel: false
  commands:
    preflight:
      run: pnpm preflight
