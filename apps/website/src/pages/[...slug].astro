---
import { type CollectionEntry, getCollection } from 'astro:content';
import { z } from 'zod';
import BaseLayout from '../layouts/BaseLayout.astro';
import MarketingLayout from '../layouts/MarketingLayout.astro';

export async function getStaticPaths() {
  const pages = await getCollection('pages');

  const paths: Array<{
    params: { slug: string | undefined };
    props: {
      doc: CollectionEntry<'pages'>;
    };
  }> = [];

  // Add pages collection - excluding index which has its own route
  for (const page of pages) {
    if (page.slug !== 'index') {
      paths.push({
        params: {
          slug: page.slug,
        },
        props: {
          doc: page,
        },
      });
    }
  }

  return paths;
}

const PropsSchema = z.object({
  doc: z.any(),
});

type Props = z.infer<typeof PropsSchema> & {
  doc: CollectionEntry<'pages'>;
};

const validatedProps = PropsSchema.parse(Astro.props);
const { doc } = validatedProps as Props;
const { Content } = await doc.render();

// Determine layout based on frontmatter
let LayoutComponent: typeof BaseLayout | typeof MarketingLayout;
let layoutProps: {
  title?: string;
  description?: string;
  headerTitle?: string;
  headerTitleClasses?: string;
} = {
  title: doc.data.title,
  description: doc.data.description,
};

switch (doc.data.pageLayout) {
  case 'marketing':
    LayoutComponent = MarketingLayout;
    layoutProps = {
      ...layoutProps,
      headerTitle: doc.data.headerTitle,
      headerTitleClasses: doc.data.headerTitleClasses,
    };
    break;
  default:
    LayoutComponent = BaseLayout;
    break;
}
---

<LayoutComponent {...layoutProps}>
  <Content />
</LayoutComponent>