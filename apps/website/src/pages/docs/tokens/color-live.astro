---
import tokenCache from '../../../data/token-cache.json';
import DocsLayout from '../../../layouts/DocsLayout.astro';

// Use cached color tokens (generated at build time when package version changes)
const { colorTokens, stats, generatedAt, version } = tokenCache;
const { all: allColorTokens, semantic: semanticColors } = colorTokens;

// Utility function to convert OKLCH object to CSS string
function oklchToCss(oklch: unknown): string {
  if (typeof oklch === 'string') return oklch;
  if (oklch && typeof oklch === 'object' && oklch.l !== undefined) {
    return `oklch(${oklch.l} ${oklch.c} ${oklch.h})`;
  }
  return 'transparent';
}

// Parse semantic token reference to find corresponding scale token
function parseSemanticTokenReference(value: string): string | null {
  // Parse "var(--color-primary-600)" to get token name "primary-600"
  const match = value.match(/var\(--color-(.+)\)/);
  return match ? match[1] : null;
}

// Find scale token by name in the allColorTokens array
function findScaleToken(tokenName: string): unknown {
  return allColorTokens.find((token) => token.name === tokenName);
}

// Get OKLCH scale value by index
function getScaleColorValue(colorValue: unknown, index = 5): string {
  if (colorValue?.scale && Array.isArray(colorValue.scale)) {
    const targetIndex = Math.min(Math.max(0, index), colorValue.scale.length - 1);
    return oklchToCss(colorValue.scale[targetIndex]);
  }
  return 'transparent';
}

// Enhanced semantic colors with resolved ColorValue data
const enhancedSemanticColors = semanticColors.map((token) => {
  const targetTokenName = parseSemanticTokenReference(token.value);
  let scaleToken = null;
  let resolvedValue = token.value;

  if (targetTokenName) {
    scaleToken = findScaleToken(targetTokenName);
    if (scaleToken?.value?.scale) {
      // Use the middle of the scale (usually index 5)
      resolvedValue = getScaleColorValue(scaleToken.value, 5);
    }
  }

  return {
    ...token,
    resolvedValue,
    scaleToken,
    targetTokenName,
  };
});
---

<DocsLayout title="Live Color Tokens" description="Live color tokens with OKLCH values and AI intelligence">
  <div class="prose prose-lg max-w-none">
    <h1>AI-Enhanced Color System</h1>
    <p class="lead">
      <strong>{stats.colorTokens} color tokens</strong> generated using the Color Intelligence API with 
      complete OKLCH scales, harmony relationships, and embedded AI intelligence metadata.
    </p>

    <!-- Component Token Usage -->
    <div class="bg-green-50 border border-green-200 rounded-lg p-6 mb-8">
      <h2 class="text-lg font-semibold text-green-900 mb-4">Component Tokens</h2>
      <p class="text-sm text-green-800 mb-4">
        These are the final tokens consumed by components and Tailwind utilities - the variables you actually use in code.
      </p>
      
      <!-- Semantic Color Tokens for Components -->
      <div class="space-y-8">
        {enhancedSemanticColors.map(token => (
          <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
            <!-- Token Header -->
            <div class="p-6 border-b border-gray-100">
              <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-4">
                  <div 
                    class="w-16 h-16 rounded-lg border-2 border-gray-300 shadow-inner"
                    style={`background-color: ${token.resolvedValue};`}
                    title={`${token.resolvedValue} (resolved from ${token.value})`}
                  ></div>
                  <div>
                    <h3 class="font-mono font-semibold text-lg">{token.name}</h3>
                    <p class="text-sm text-gray-600 mb-1">{token.semanticMeaning}</p>
                    <code class="text-xs bg-gray-100 px-2 py-1 rounded">
                      --color-{token.name}
                    </code>
                    {token.targetTokenName && (
                      <div class="text-xs text-gray-500 mt-1">
                        Resolves to: {token.targetTokenName}
                      </div>
                    )}
                  </div>
                </div>
                
                <!-- Intelligence Metadata -->
                <div class="flex flex-wrap gap-2">
                  <span class={`px-3 py-1 rounded-full text-xs font-medium ${
                    token.trustLevel === 'low' ? 'bg-blue-100 text-blue-800' :
                    token.trustLevel === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                    token.trustLevel === 'high' ? 'bg-orange-100 text-orange-800' :
                    'bg-red-100 text-red-800'
                  }`}>
                    Trust: {token.trustLevel}
                  </span>
                  <span class={`px-3 py-1 rounded-full text-xs font-medium ${
                    token.cognitiveLoad <= 3 ? 'bg-green-100 text-green-800' :
                    token.cognitiveLoad <= 6 ? 'bg-yellow-100 text-yellow-800' :
                    'bg-red-100 text-red-800'
                  }`}>
                    Load: {token.cognitiveLoad}/10
                  </span>
                  <span class="px-3 py-1 bg-gray-100 text-gray-800 rounded-full text-xs font-medium">
                    {token.accessibilityLevel}
                  </span>
                </div>
              </div>
            </div>

            <!-- Rich Color Intelligence Data -->
            {token.scaleToken && token.scaleToken.value && (
              <div class="p-6 space-y-6">
                
                <!-- OKLCH Color Scale -->
                {token.scaleToken.value.scale && (
                  <div>
                    <h4 class="font-medium mb-3">Complete OKLCH Scale ({token.scaleToken.value.scale.length} steps)</h4>
                    <div class="grid grid-cols-11 gap-1 mb-2">
                      {token.scaleToken.value.scale.map((oklch, index) => (
                        <div class="text-center">
                          <div 
                            class="w-full h-12 rounded border border-gray-300 shadow-sm"
                            style={`background-color: ${oklchToCss(oklch)};`}
                            title={`${index * 100}: ${oklchToCss(oklch)}`}
                          ></div>
                          <div class="text-xs text-gray-500 mt-1">{index * 100}</div>
                        </div>
                      ))}
                    </div>
                    <div class="text-xs text-gray-600">
                      <strong>Base OKLCH:</strong> L={token.scaleToken.value.scale[5]?.l} C={token.scaleToken.value.scale[5]?.c} H={token.scaleToken.value.scale[5]?.h}Â°
                    </div>
                  </div>
                )}

                <!-- Color Harmonies -->
                {token.scaleToken.value.harmonies && (
                  <div>
                    <h4 class="font-medium mb-3">Color Harmonies</h4>
                    <div class="grid md:grid-cols-2 gap-4">
                      
                      <!-- Complementary -->
                      {token.scaleToken.value.harmonies.complementary && (
                        <div class="bg-gray-50 rounded-lg p-4">
                          <h5 class="font-medium text-sm mb-2">Complementary</h5>
                          <div class="flex items-center gap-3">
                            <div 
                              class="w-8 h-8 rounded border border-gray-300"
                              style={`background-color: ${token.resolvedValue};`}
                              title="Original color"
                            ></div>
                            <div class="text-gray-400">+</div>
                            <div 
                              class="w-8 h-8 rounded border border-gray-300"
                              style={`background-color: ${oklchToCss(token.scaleToken.value.harmonies.complementary)};`}
                              title="Complementary color"
                            ></div>
                          </div>
                          <div class="text-xs text-gray-600 mt-2">
                            {oklchToCss(token.scaleToken.value.harmonies.complementary)}
                          </div>
                        </div>
                      )}

                      <!-- Triadic -->
                      {token.scaleToken.value.harmonies.triadic && Array.isArray(token.scaleToken.value.harmonies.triadic) && (
                        <div class="bg-gray-50 rounded-lg p-4">
                          <h5 class="font-medium text-sm mb-2">Triadic</h5>
                          <div class="flex items-center gap-2">
                            <div 
                              class="w-6 h-6 rounded border border-gray-300"
                              style={`background-color: ${token.resolvedValue};`}
                              title="Original color"
                            ></div>
                            {token.scaleToken.value.harmonies.triadic.map((triadic, index) => (
                              <>
                                <div class="text-gray-400">+</div>
                                <div 
                                  class="w-6 h-6 rounded border border-gray-300"
                                  style={`background-color: ${oklchToCss(triadic)};`}
                                  title={`Triadic ${index + 1}: ${oklchToCss(triadic)}`}
                                ></div>
                              </>
                            ))}
                          </div>
                          <div class="text-xs text-gray-600 mt-2">
                            {token.scaleToken.value.harmonies.triadic.length} triadic colors
                          </div>
                        </div>
                      )}

                    </div>
                  </div>
                )}

                <!-- Accessibility Matrix -->
                {token.scaleToken.value.accessibility && (
                  <div>
                    <h4 class="font-medium mb-3">WCAG Accessibility Matrix</h4>
                    <div class="bg-gray-50 rounded-lg p-4">
                      <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                          <h5 class="font-medium mb-2">Normal Text (AA)</h5>
                          {token.scaleToken.value.accessibility.wcagAA?.normal && (
                            <div class="space-y-1">
                              {token.scaleToken.value.accessibility.wcagAA.normal.map(([start, end], index) => (
                                <div class="flex items-center gap-2">
                                  <div class="text-xs text-gray-600">
                                    {start * 100}-{end * 100}:
                                  </div>
                                  <div class="flex gap-1">
                                    {Array.from({length: end - start + 1}, (_, i) => (
                                      <div 
                                        class="w-4 h-4 rounded border border-gray-300"
                                        style={`background-color: ${getScaleColorValue(token.scaleToken.value, start + i)};`}
                                        title={`Scale ${(start + i) * 100}: WCAG AA compliant`}
                                      ></div>
                                    ))}
                                  </div>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                        <div>
                          <h5 class="font-medium mb-2">Large Text (AA)</h5>
                          {token.scaleToken.value.accessibility.wcagAA?.large && (
                            <div class="space-y-1">
                              {token.scaleToken.value.accessibility.wcagAA.large.map(([start, end], index) => (
                                <div class="flex items-center gap-2">
                                  <div class="text-xs text-gray-600">
                                    {start * 100}-{end * 100}:
                                  </div>
                                  <div class="flex gap-1">
                                    {Array.from({length: end - start + 1}, (_, i) => (
                                      <div 
                                        class="w-4 h-4 rounded border border-gray-300"
                                        style={`background-color: ${getScaleColorValue(token.scaleToken.value, start + i)};`}
                                        title={`Scale ${(start + i) * 100}: WCAG AA large text`}
                                      ></div>
                                    ))}
                                  </div>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                <!-- Usage Information -->
                <div class="grid md:grid-cols-3 gap-4 text-sm">
                  <div>
                    <h4 class="font-medium mb-2">Tailwind Usage:</h4>
                    <div class="space-y-1 font-mono text-xs">
                      <div><span class="text-red-600">bg-{token.name}</span></div>
                      <div><span class="text-red-600">text-{token.name}</span></div>
                      <div><span class="text-red-600">border-{token.name}</span></div>
                    </div>
                  </div>
                  <div>
                    <h4 class="font-medium mb-2">Components:</h4>
                    <div class="flex flex-wrap gap-1">
                      {token.applicableComponents?.map(component => (
                        <span class="inline-block px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs">
                          {component}
                        </span>
                      ))}
                    </div>
                  </div>
                  <div>
                    <h4 class="font-medium mb-2">Properties:</h4>
                    <div class="space-y-1 text-xs text-gray-600">
                      <div><strong>Consequence:</strong> {token.consequence}</div>
                      <div><strong>Scale Position:</strong> {token.scalePosition}</div>
                      <div><strong>Resolves to:</strong> {token.targetTokenName}</div>
                      {token.scaleToken?.value?.use && (
                        <div><strong>Use Case:</strong> {token.scaleToken.value.use}</div>
                      )}
                    </div>
                  </div>
                </div>

              </div>
            )}

            {/* Fallback for tokens without resolved scale token */}
            {!token.scaleToken && (
              <div class="p-6 bg-yellow-50 border-t border-yellow-200">
                <div class="text-sm text-yellow-800">
                  <strong>Missing Scale Token:</strong> This semantic token references "{token.value}" but the target scale token "{token.targetTokenName}" could not be found in the color tokens.
                </div>
              </div>
            )}

          </div>
        ))}
      </div>
    </div>
  </div>
</DocsLayout>