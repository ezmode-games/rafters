---
/**
 * ComponentPreview - Build-time component rendering with AstroSWCBuilder
 *
 * Pre-renders Rafters UI components at build time using the complete SWC pipeline.
 * Generates static HTML ready for Cloudflare Workers deployment (no runtime compilation).
 */

import { AstroSWCBuilder } from '../lib/swc/AstroSWCBuilder';
import type { BuildResult } from '../lib/swc/AstroSWCBuilder';

interface Props {
  component: string;
  variant?: string;
  props?: string;
  showIntelligence?: boolean;
  height?: string;
  class?: string;
}

const {
  component,
  variant = 'default',
  props: propsString = '{}',
  showIntelligence = false,
  height = '200px',
  class: className = '',
} = Astro.props;

// Parse props from JSON string
let componentProps: Record<string, unknown> = {};
try {
  componentProps = JSON.parse(propsString);
} catch (e) {
  console.warn(`Failed to parse props for ${component}:`, e);
}

// Add variant to props if specified
if (variant && variant !== 'default') {
  componentProps.variant = variant;
}

// Build component at build time using SWC pipeline
const builder = new AstroSWCBuilder({
  componentTimeout: 5000,
  enableSourceMaps: false,
});

let buildResult: BuildResult | null = null;
let errorMessage: string | null = null;

try {
  buildResult = await builder.buildComponentPreview(component, componentProps);
} catch (error) {
  errorMessage = error instanceof Error ? error.message : 'Unknown build error';
  console.error(`Failed to build preview for ${component}:`, error);
}

// Generate unique ID for this preview
const previewId = `preview-${component}-${Math.random().toString(36).substr(2, 9)}`;
---

<div
  class={`component-preview-wrapper border rounded-lg p-4 ${className}`}
  data-component={component}
  data-variant={variant}
>
  {showIntelligence && buildResult?.intelligence && (
    <div class="preview-intelligence mb-3 text-sm text-gray-600">
      <div class="space-y-1">
        <div><strong>Cognitive Load:</strong> {buildResult.intelligence.cognitiveLoad}/10</div>
        <div><strong>Attention:</strong> {buildResult.intelligence.attentionEconomics}</div>
        <div><strong>Trust:</strong> {buildResult.intelligence.trustBuilding}</div>
        {buildResult.cacheHit && (
          <div class="text-xs text-gray-500">âš¡ Cached ({buildResult.buildTime}ms)</div>
        )}
      </div>
    </div>
  )}

  <div
    id={previewId}
    class="preview-container bg-white border rounded flex items-center justify-center"
    style={`height: ${height}; position: relative;`}
  >
    {buildResult ? (
      <Fragment set:html={buildResult.htmlOutput} />
    ) : (
      <div class="error-fallback text-center text-red-600">
        <div class="font-semibold">Component Build Error</div>
        <div class="text-sm">{errorMessage}</div>
      </div>
    )}
  </div>

  {buildResult && (
    <div class="preview-meta mt-2 text-xs text-gray-500">
      Built in {buildResult.buildTime}ms
      {buildResult.cacheHit && ' (cached)'}
    </div>
  )}

  <!-- Error state for build failures -->
  {errorMessage && (
    <div class="error-state mt-2 p-3 bg-red-50 border border-red-200 rounded text-red-700 text-sm">
      <strong>Component Error:</strong>
      <div class="error-message">{errorMessage}</div>
    </div>
  )}
</div>