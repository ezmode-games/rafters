# Rafters API

Cloudflare Workers API for color intelligence and design token generation.

## Quick Start

```bash
pnpm install
pnpm run dev
```

## Endpoints

### GET /color/:oklch

Get comprehensive color data for an OKLCH color value.

**Path format:** `L.LLL-C.CCC-H` (e.g., `0.650-0.120-230`)

**Query params:**
- `adhoc=true` - Fast math-only response (no AI, no vector lookup)
- `sync=true` - Wait for AI generation if not cached

**Response includes:**
- Deterministic three-word color name (e.g., "dove-true-cobalt")
- 11-position color scale (50-950)
- Color harmonies (complementary, triadic, analogous, tetradic)
- Accessibility metadata (WCAG AA/AAA, APCA scores)
- Perceptual and atmospheric weight analysis
- Semantic role suggestions

### GET /color/search

Semantic search for colors using natural language.

**Query params:**
- `q` (required) - Search query (e.g., "ocean blue", "warm sunset")
- `hue` - Filter by hue category
- `lightness` - Filter by lightness category
- `chroma` - Filter by chroma category
- `token` - Filter by semantic token
- `limit` - Max results (default: 10)

### POST /queue

Queue a single color for AI intelligence generation.

**Request body:**
```json
{
  "color": { "l": 0.65, "c": 0.12, "h": 230, "alpha": 1 },
  "token": "primary",
  "name": "brand-blue"
}
```

### POST /queue/batch

Queue multiple colors for processing (max 1000).

**Request body:**
```json
{
  "colors": [
    { "l": 0.65, "c": 0.12, "h": 230, "alpha": 1 },
    { "l": 0.45, "c": 0.15, "h": 15, "alpha": 1 }
  ],
  "batchId": "my-palette"
}
```

### POST /queue/spectrum

Generate and queue a full color spectrum for seeding the vector database.

**Request body:**
```json
{
  "lightnessSteps": 9,
  "chromaSteps": 5,
  "hueSteps": 12,
  "baseName": "spectrum-seed"
}
```

Generates `lightnessSteps × chromaSteps × hueSteps` colors (default: 9 × 5 × 12 = 540 colors).

### GET /queue/list

Get queue backlog status.

**Response:**
```json
{
  "success": true,
  "backlogCount": 42
}
```

Returns the average backlog count from the last 5 minutes via the Cloudflare GraphQL Analytics API. Requires `CF_ACCOUNT_ID` and `CF_API_TOKEN` environment variables.

## Architecture

### Color Naming

Color names are **deterministic** - the same OKLCH input always produces the same name. Names use a three-word format:

```
{luminosity}-{intensity}-{material}
```

- **Luminosity** (from L): obsidian, coal, slate, stone, silver, dove, bone, ivory, snow
- **Intensity** (from C + perceptual weight): whisper, soft, clear, bold, vivid, electric
- **Material** (from H + temperature): Uses expanded "hub" word banks for red, green, blue hues with 200+ words each; falls back to simpler word banks for other hues

Generated by `generateColorName()` from `@rafters/color-utils`.

### Color Intelligence

AI-powered analysis (separate from naming) provides:
- Reasoning about OKLCH combinations
- Emotional impact analysis
- Cultural context
- Accessibility notes
- Usage guidance

Uses Workers AI (Llama 4 Scout) with uncertainty quantification.

### Vector Search

Colors are stored in Cloudflare Vectorize with embeddings generated from:
- Deterministic color name (weighted for emphasis)
- AI intelligence fields (emotional impact, reasoning, cultural context)
- Semantic role if assigned

## Development

```bash
# Generate Cloudflare types
pnpm run cf-typegen

# Run tests
pnpm test

# Type check
pnpm typecheck

# Deploy
pnpm run deploy
```

## Bindings

Pass `CloudflareBindings` as generics when instantiating Hono:

```ts
const app = new Hono<{ Bindings: CloudflareBindings }>()
```
