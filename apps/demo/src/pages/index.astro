---
/**
 * Main Index - Rafters Design Intelligence Protocol
 *
 * The protocol is the product. Components are proof.
 *
 * Uses Rafters components:
 * - Container: main landmark with size constraint
 * - Grid: linear preset for equal-priority cards, golden for hero
 * - Card: interactive cards for doc links
 * - Typography: H1, H2, Lead, Muted for hierarchy
 * - Badge: section indicators
 * - Separator: visual division
 */

import { getCollection } from 'astro:content';
import { Badge } from '@rafters/ui/components/ui/badge';
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from '@rafters/ui/components/ui/card';
import { Container } from '@rafters/ui/components/ui/container';
import { Grid } from '@rafters/ui/components/ui/grid';
import { Separator } from '@rafters/ui/components/ui/separator';
import { H1, H2, H3, Lead, Muted, P } from '@rafters/ui/components/ui/typography';
import BaseLayout from '../layouts/BaseLayout.astro';
import { loadAllComponents } from '../lib/component-registry';

const allDocs = await getCollection('docs', ({ data }) => !data.draft);
const components = loadAllComponents();

// Group docs by section
const sections = {
  concepts: { label: 'Concepts', docs: [] as typeof allDocs },
  tokens: { label: 'Tokens', docs: [] as typeof allDocs },
  components: { label: 'Components', docs: [] as typeof allDocs },
  patterns: { label: 'Patterns', docs: [] as typeof allDocs },
  guides: { label: 'Guides', docs: [] as typeof allDocs },
};

for (const doc of allDocs) {
  const section = doc.data.section || 'concepts';
  if (sections[section]) {
    sections[section].docs.push(doc);
  }
}

// Sort each section by order
for (const section of Object.values(sections)) {
  section.docs.sort((a, b) => (a.data.order || 999) - (b.data.order || 999));
}

// Stats
const totalDocs = allDocs.length;
const totalComponents = components.length;
---

<BaseLayout title="Rafters" description="Design Intelligence Protocol - AI reads decisions, not guesses">
  <Container as="main" size="5xl" padding="6">
    {/* Hero */}
    <header class="py-16">
      <Badge variant="outline" size="sm" class="mb-6">Design Intelligence Protocol</Badge>
      <H1 class="mb-6 max-w-3xl">
        AI agents don't have taste.<br/>
        <span class="text-muted-foreground">Rafters gives them yours.</span>
      </H1>
      <Lead class="max-w-2xl mb-8">
        Encode your design judgment into queryable data. AI reads decisions that have already been made instead of guessing at colors, spacing, and hierarchy.
      </Lead>
      
      {/* Quick stats */}
      <div class="flex gap-8">
        <div>
          <span class="text-3xl font-semibold text-primary">{totalDocs}</span>
          <Muted class="ml-2">docs</Muted>
        </div>
        <div>
          <span class="text-3xl font-semibold text-primary">{totalComponents}</span>
          <Muted class="ml-2">components</Muted>
        </div>
        <div>
          <span class="text-3xl font-semibold text-primary">4</span>
          <Muted class="ml-2">MCP tools</Muted>
        </div>
      </div>
    </header>

    <Separator class="mb-16" />

    {/* Foundation Systems */}
    <section class="mb-16">
      <H2 class="mb-2">Foundation</H2>
      <Muted class="mb-8">Mathematical systems that generate consistent, accessible design</Muted>
      
      <Grid preset="linear" columns={2} gap="6">
        <Card as="article">
          <CardHeader>
            <Badge variant="accent" size="sm" class="w-fit mb-2">Color Intelligence</Badge>
            <CardTitle as="h3">OKLCH Color System</CardTitle>
            <CardDescription>
              Perceptually uniform color space with contrast-based scale generation. Each position targets specific WCAG ratios.
            </CardDescription>
          </CardHeader>
          <CardContent class="space-y-4">
            <div>
              <Muted class="text-xs mb-2 block">11-position scale (50-950)</Muted>
              <div class="flex gap-0.5">
                <div class="w-6 h-6 rounded-sm" style="background: oklch(0.98 0.02 240);" title="50 - L:0.98"></div>
                <div class="w-6 h-6 rounded-sm" style="background: oklch(0.95 0.03 240);" title="100 - L:0.95"></div>
                <div class="w-6 h-6 rounded-sm" style="background: oklch(0.90 0.05 240);" title="200 - L:0.90"></div>
                <div class="w-6 h-6 rounded-sm" style="background: oklch(0.80 0.08 240);" title="300 - L:0.80"></div>
                <div class="w-6 h-6 rounded-sm" style="background: oklch(0.70 0.12 240);" title="400 - L:0.70"></div>
                <div class="w-6 h-6 rounded-sm" style="background: oklch(0.55 0.15 240);" title="500 - L:0.55"></div>
                <div class="w-6 h-6 rounded-sm" style="background: oklch(0.40 0.14 240);" title="600 - L:0.40"></div>
                <div class="w-6 h-6 rounded-sm" style="background: oklch(0.25 0.12 240);" title="700 - L:0.25"></div>
                <div class="w-6 h-6 rounded-sm" style="background: oklch(0.15 0.10 240);" title="800 - L:0.15"></div>
                <div class="w-6 h-6 rounded-sm" style="background: oklch(0.08 0.08 240);" title="900 - L:0.08"></div>
                <div class="w-6 h-6 rounded-sm" style="background: oklch(0.04 0.06 240);" title="950 - L:0.04"></div>
              </div>
            </div>
            <div class="text-xs space-y-1">
              <div class="flex justify-between">
                <span class="text-muted-foreground">Pre-computed accessibility:</span>
                <span>WCAG AA/AAA pairs, APCA</span>
              </div>
              <div class="flex justify-between">
                <span class="text-muted-foreground">Color harmonies:</span>
                <span>Triadic, analogous, tetradic</span>
              </div>
              <div class="flex justify-between">
                <span class="text-muted-foreground">Semantic naming:</span>
                <span>luminous-clear-sapphire</span>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card as="article">
          <CardHeader>
            <Badge variant="secondary" size="sm" class="w-fit mb-2">Math Intelligence</Badge>
            <CardTitle as="h3">Musical Progressions</CardTitle>
            <CardDescription>
              Spacing and typography scales derived from musical intervals. Harmonious relationships, not arbitrary values.
            </CardDescription>
          </CardHeader>
          <CardContent class="space-y-4">
            <div>
              <Muted class="text-xs mb-2 block">Minor third (1.2) progression</Muted>
              <div class="flex items-end gap-1">
                <div class="w-4 bg-muted-foreground/40 rounded-sm" style="height: 8px;" title="base / 1.2"></div>
                <div class="w-4 bg-muted-foreground/50 rounded-sm" style="height: 10px;" title="base"></div>
                <div class="w-4 bg-muted-foreground/60 rounded-sm" style="height: 12px;" title="base * 1.2"></div>
                <div class="w-4 bg-muted-foreground/70 rounded-sm" style="height: 14px;" title="base * 1.44"></div>
                <div class="w-4 bg-muted-foreground/80 rounded-sm" style="height: 17px;" title="base * 1.728"></div>
                <div class="w-4 bg-muted-foreground/90 rounded-sm" style="height: 21px;" title="base * 2.074"></div>
                <div class="w-4 bg-muted-foreground rounded-sm" style="height: 25px;" title="base * 2.488"></div>
              </div>
            </div>
            <div class="text-xs space-y-1">
              <div class="flex justify-between">
                <span class="text-muted-foreground">Minor third:</span>
                <span>1.2 (6:5 ratio)</span>
              </div>
              <div class="flex justify-between">
                <span class="text-muted-foreground">Perfect fourth:</span>
                <span>1.333 (4:3 ratio)</span>
              </div>
              <div class="flex justify-between">
                <span class="text-muted-foreground">Golden ratio:</span>
                <span>1.618 (phi)</span>
              </div>
            </div>
          </CardContent>
        </Card>
      </Grid>
    </section>

    {/* Color API */}
    <section class="mb-16">
      <div class="flex items-baseline gap-4 mb-8">
        <H3>Color API</H3>
        <Muted>Real-time color intelligence via REST</Muted>
      </div>

      <Grid preset="linear" columns={2} gap="6">
        <Card as="article">
          <CardHeader>
            <Badge variant="outline" size="sm" className="w-fit mb-2">GET /color/:oklch</Badge>
            <CardTitle as="h4" className="text-base">Instant Analysis</CardTitle>
            <CardDescription>
              Pass any OKLCH color, get complete intelligence back. Adhoc mode returns math-only results in milliseconds.
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-3">
            <div class="bg-muted/50 rounded-md p-3 text-xs font-mono overflow-x-auto">
              <div class="text-muted-foreground"># Request</div>
              <div>GET /color/0.65-0.15-240?adhoc=true</div>
              <div class="mt-2 text-muted-foreground"># Response</div>
              <div class="text-foreground/80">{"{"} scale: [...11 positions], harmony: {"{"} complementary, triadic, ... {"}"} {"}"}</div>
            </div>
            <div class="text-xs space-y-1">
              <div class="flex justify-between">
                <span class="text-muted-foreground">Full mode:</span>
                <span>AI-powered emotional, cultural context</span>
              </div>
              <div class="flex justify-between">
                <span class="text-muted-foreground">Adhoc mode:</span>
                <span>Pure math, instant response</span>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card as="article">
          <CardHeader>
            <Badge variant="outline" size="sm" className="w-fit mb-2">GET /color/search</Badge>
            <CardTitle as="h4" className="text-base">Semantic Search</CardTitle>
            <CardDescription>
              Find colors by meaning. Vector embeddings match natural language queries to cached color intelligence.
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-3">
            <div class="bg-muted/50 rounded-md p-3 text-xs font-mono overflow-x-auto">
              <div class="text-muted-foreground"># Request</div>
              <div>GET /color/search?q=calm+professional+blue</div>
              <div class="mt-2 text-muted-foreground"># Response</div>
              <div class="text-foreground/80">[{"{"} oklch: "0.55-0.08-240", score: 0.92 {"}"}, ...]</div>
            </div>
            <div class="text-xs space-y-1">
              <div class="flex justify-between">
                <span class="text-muted-foreground">Embedding model:</span>
                <span>Workers AI bge-base-en-v1.5</span>
              </div>
              <div class="flex justify-between">
                <span class="text-muted-foreground">Filtering:</span>
                <span>Hue, lightness, chroma ranges</span>
              </div>
            </div>
          </CardContent>
        </Card>
      </Grid>
    </section>

    <Separator class="mb-16" />

    {/* Three Layers */}
    <section class="mb-16">
      <H2 class="mb-2">Three Layers</H2>
      <Muted class="mb-8">What, where, and why of design decisions</Muted>
      
      <Grid preset="linear" columns={3} gap="6">
        <Card as="article">
          <CardHeader>
            <Badge variant="secondary" size="sm" class="w-fit mb-2">What</Badge>
            <CardTitle as="h3">Components</CardTitle>
            <CardDescription>
              UI building blocks with embedded intelligence. Cognitive load scores, accessibility requirements, trust patterns in JSDoc.
            </CardDescription>
          </CardHeader>
          <CardContent>
            <a href="/gallery" class="text-sm text-primary hover:underline">
              View {totalComponents} components
            </a>
          </CardContent>
        </Card>

        <Card as="article">
          <CardHeader>
            <Badge variant="accent" size="sm" class="w-fit mb-2">Where</Badge>
            <CardTitle as="h3">Tokens</CardTitle>
            <CardDescription>
              Dependency graph with human override tracking. Change the base, derived values update. Override a computed value, the system remembers why.
            </CardDescription>
          </CardHeader>
          <CardContent>
            <a href="/docs/tokens" class="text-sm text-primary hover:underline">
              Learn about tokens
            </a>
          </CardContent>
        </Card>

        <Card as="article">
          <CardHeader>
            <Badge variant="default" size="sm" class="w-fit mb-2">Why</Badge>
            <CardTitle as="h3">Decisions</CardTitle>
            <CardDescription>
              Do and never patterns with context. Not "use this button" but "because irreversible actions need confirmation and 3-second delay."
            </CardDescription>
          </CardHeader>
          <CardContent>
            <a href="/docs/what-is-rafters" class="text-sm text-primary hover:underline">
              Understand the protocol
            </a>
          </CardContent>
        </Card>
      </Grid>
    </section>

    <Separator class="mb-16" />

    {/* MCP Tools */}
    <section class="mb-16">
      <H2 class="mb-2">MCP Tools</H2>
      <Muted class="mb-8">How AI agents query design intelligence</Muted>

      <Grid preset="linear" columns={2} gap="6">
        <Card>
          <CardHeader>
            <CardTitle as="h3">Vocabulary</CardTitle>
            <CardDescription>
              "What do I have to work with?"
            </CardDescription>
          </CardHeader>
          <CardContent>
            <P class="text-sm text-muted-foreground">
              Returns available colors, spacing, components. The boundaries of the design system.
            </P>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle as="h3">Pattern</CardTitle>
            <CardDescription>
              "How do I implement this scenario?"
            </CardDescription>
          </CardHeader>
          <CardContent>
            <P class="text-sm text-muted-foreground">
              Full guidance for patterns like destructive-action, form-validation, empty-state.
            </P>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle as="h3">Component</CardTitle>
            <CardDescription>
              "Tell me everything about this component."
            </CardDescription>
          </CardHeader>
          <CardContent>
            <P class="text-sm text-muted-foreground">
              Complete intelligence parsed from JSDoc: cognitive load, accessibility, usage patterns.
            </P>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle as="h3">Token</CardTitle>
            <CardDescription>
              "What's the story behind this value?"
            </CardDescription>
          </CardHeader>
          <CardContent>
            <P class="text-sm text-muted-foreground">
              Dependency graph, derivation rules, and human override context. See what the system computes vs what a designer chose and why.
            </P>
          </CardContent>
        </Card>
      </Grid>

      <div class="mt-6">
        <a href="/docs/mcp-tools" class="text-sm text-primary hover:underline">
          Learn more about MCP integration
        </a>
      </div>
    </section>

    <Separator class="mb-16" />

    {/* Documentation */}
    <section class="mb-16">
      <div class="flex items-center justify-between mb-8">
        <div>
          <H2 class="mb-2">Documentation</H2>
          <Muted>Learn the protocol</Muted>
        </div>
        <a href="/docs" class="text-sm text-primary hover:underline">
          View all docs
        </a>
      </div>
      
      <Grid preset="linear" columns={2} gap="4">
        {sections.concepts.docs.slice(0, 4).map((doc) => (
          <a href={`/docs/${doc.slug}`} class="no-underline">
            <Card interactive as="article" class="h-full">
              <CardHeader>
                <CardTitle as="h3" class="text-lg">
                  {doc.data.title}
                </CardTitle>
                <CardDescription>
                  {doc.data.description}
                </CardDescription>
              </CardHeader>
            </Card>
          </a>
        ))}
      </Grid>
    </section>

    {/* Footer */}
    <Separator class="mb-8" />
    <footer class="pb-8">
      <div class="flex items-center justify-between">
        <div class="flex gap-6">
          <a href="/gallery" class="text-sm text-muted-foreground hover:text-foreground transition-colors">
            Component Gallery
          </a>
          <a href="/editor" class="text-sm text-muted-foreground hover:text-foreground transition-colors">
            Editor Playground
          </a>
          <a href="/docs" class="text-sm text-muted-foreground hover:text-foreground transition-colors">
            Documentation
          </a>
        </div>
        <Muted>Rafters Design Intelligence Protocol</Muted>
      </div>
    </footer>
  </Container>
</BaseLayout>
