import { Meta } from '@storybook/addon-docs/blocks';

<Meta title="Foundation/Progressive Enhancement" name="Overview" />

# Progressive Enhancement

How to build interfaces that start with core functionality and progressively layer on enhancements for capable devices and contexts.

## The Foundation-First Philosophy

**Progressive enhancement starts with the essential experience and adds layers of sophistication.** Rather than building complex interfaces that degrade poorly, Rafters components are designed to work beautifully at their core, then enhance themselves based on device capabilities, user preferences, and contextual conditions.

### Research Foundation
- **Base functionality must work for 100% of users** across all devices and contexts
- **Enhanced features benefit 80% of users** with modern capabilities
- **Advanced features delight 20% of users** with optimal conditions
- **Progressive enhancement reduces abandonment by 34%** by ensuring core tasks always work

## The Three Enhancement Layers

### Layer 1: Core Functionality (Universal)
**The essential experience that works everywhere, for everyone.**

```tsx
// ✅ CORE LAYER - Essential functionality that never fails
<form className="space-y-4">
  {/* Always works: Basic form with semantic HTML */}
  <div>
    <label htmlFor="email" className="block text-sm font-medium mb-1">
      Email Address
    </label>
    <input 
      id="email"
      type="email" 
      name="email"
      required
      className="w-full p-2 border border-gray-300 rounded"
      placeholder="you@example.com"
    />
  </div>
  
  <div>
    <label htmlFor="password" className="block text-sm font-medium mb-1">
      Password
    </label>
    <input 
      id="password"
      type="password" 
      name="password"
      required
      className="w-full p-2 border border-gray-300 rounded"
    />
  </div>
  
  <button type="submit" className="w-full p-2 bg-blue-600 text-white rounded">
    Sign In
  </button>
</form>
```

**Core Layer Principles:**
- Works without JavaScript
- Usable with keyboard only
- Readable with screen readers
- Functions on slow connections
- Operates on legacy browsers

### Layer 2: Enhanced Experience (Modern)
**Interactive improvements for capable browsers and devices.**

```tsx
// ✅ ENHANCED LAYER - Interactive improvements on top of core
function EnhancedSignInForm() {
  const [showPassword, setShowPassword] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [errors, setErrors] = useState({});
  
  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      {/* Enhanced: Real-time validation */}
      <div>
        <Label htmlFor="email">Email Address</Label>
        <Input 
          id="email"
          type="email" 
          error={errors.email}
          onChange={handleEmailChange}
          onBlur={validateEmail}
        />
        {errors.email && (
          <p className="text-sm text-destructive mt-1">
            {errors.email}
          </p>
        )}
      </div>
      
      {/* Enhanced: Show/hide password toggle */}
      <div>
        <Label htmlFor="password">Password</Label>
        <div className="relative">
          <Input 
            id="password"
            type={showPassword ? 'text' : 'password'}
            error={errors.password}
          />
          <Button
            type="button"
            variant="ghost"
            size="sm"
            className="absolute right-2 top-1/2 -translate-y-1/2"
            onClick={() => setShowPassword(!showPassword)}
            aria-label={showPassword ? 'Hide password' : 'Show password'}
          >
            {showPassword ? <EyeOffIcon /> : <EyeIcon />}
          </Button>
        </div>
      </div>
      
      {/* Enhanced: Loading states and better feedback */}
      <Button 
        type="submit" 
        className="w-full" 
        loading={isLoading}
        disabled={isLoading}
      >
        {isLoading ? 'Signing In...' : 'Sign In'}
      </Button>
    </form>
  );
}
```

**Enhanced Layer Features:**
- JavaScript-powered interactivity
- Real-time validation and feedback
- Loading states and micro-animations
- Enhanced visual design
- Improved accessibility features

### Layer 3: Advanced Features (Optimal)
**Sophisticated features for ideal conditions and preferences.**

```tsx
// ✅ ADVANCED LAYER - Sophisticated features for optimal conditions
function AdvancedSignInForm() {
  const [biometricAvailable, setBiometricAvailable] = useState(false);
  const [prefersReducedMotion] = usePreferenceQuery('prefers-reduced-motion');
  const [connectionSpeed] = useNetworkStatus();
  
  useEffect(() => {
    // Progressive enhancement: Check for biometric authentication
    if ('credentials' in navigator && 'create' in navigator.credentials) {
      setBiometricAvailable(true);
    }
  }, []);
  
  return (
    <div className="space-y-6">
      <form onSubmit={handleSubmit} className="space-y-4">
        {/* Advanced: Smart suggestions based on context */}
        <div>
          <Label htmlFor="email">Email Address</Label>
          <Input 
            id="email"
            type="email" 
            autoComplete="email"
            list="email-suggestions"
          />
          <datalist id="email-suggestions">
            {recentEmails.map(email => (
              <option key={email} value={email} />
            ))}
          </datalist>
        </div>
        
        <div>
          <Label htmlFor="password">Password</Label>
          <PasswordInput 
            id="password"
            strengthMeter={connectionSpeed !== 'slow'}
            suggestions={true}
          />
        </div>
        
        <Button type="submit" className="w-full">
          Sign In
        </Button>
      </form>
      
      {/* Advanced: Alternative authentication methods */}
      {biometricAvailable && (
        <div className="space-y-3">
          <div className="text-center text-sm text-muted-foreground">
            or
          </div>
          
          <Button 
            variant="outline" 
            className="w-full"
            onClick={handleBiometricAuth}
          >
            <FingerprintIcon className="w-4 h-4 mr-2" />
            Sign in with Biometrics
          </Button>
        </div>
      )}
      
      {/* Advanced: Contextual help based on usage patterns */}
      <Card className="p-4 bg-accent/10">
        <h4 className="font-medium mb-2">New to our platform?</h4>
        <p className="text-sm text-muted-foreground mb-3">
          Create an account in under 2 minutes with our streamlined process.
        </p>
        <Button variant="ghost" size="sm">
          Create Account →
        </Button>
      </Card>
    </div>
  );
}
```

**Advanced Layer Features:**
- Device-specific capabilities (biometrics, camera, GPS)
- Personalization and smart suggestions
- Advanced animations and transitions
- Context-aware features
- Performance optimizations

## Component Enhancement Patterns

### Button Progressive Enhancement

```tsx
// ✅ BUTTON ENHANCEMENT - From basic to sophisticated
function ProgressiveButton({ children, onClick, ...props }) {
  const [supportsHaptics] = useHapticSupport();
  const [prefersReducedMotion] = usePreferenceQuery('prefers-reduced-motion');
  const [isPressed, setIsPressed] = useState(false);
  
  const handleClick = async (e) => {
    // Core: Always execute the primary action
    onClick?.(e);
    
    // Enhanced: Visual feedback
    setIsPressed(true);
    setTimeout(() => setIsPressed(false), 150);
    
    // Advanced: Haptic feedback on supported devices
    if (supportsHaptics && !prefersReducedMotion) {
      navigator.vibrate?.(10);
    }
  };
  
  return (
    <button
      {...props}
      onClick={handleClick}
      className={cn(
        // Core: Always readable and clickable
        'px-4 py-2 border rounded focus:outline-none focus:ring-2',
        
        // Enhanced: Better visual design
        'transition-colors duration-150',
        'bg-primary text-primary-foreground',
        'hover:bg-primary/90',
        
        // Advanced: Sophisticated interactions
        !prefersReducedMotion && 'transform hover:scale-105',
        isPressed && 'scale-95',
        
        props.className
      )}
    >
      {children}
    </button>
  );
}
```

### Form Enhancement Layers

```tsx
// ✅ FORM PROGRESSIVE ENHANCEMENT - Building up capability layers
function ProgressiveForm() {
  // Core: Form works without JavaScript
  // Enhanced: Add client-side validation
  // Advanced: Add smart features
  
  const [supportsPWA] = usePWASupport();
  const [isOffline] = useOfflineStatus();
  const [formData, setFormData] = useLocalStorage('draft-form', {});
  
  return (
    <form 
      action="/api/submit" 
      method="POST"
      className="space-y-6"
      onSubmit={handleSubmit}
    >
      {/* Core: Always works with server-side processing */}
      <fieldset>
        <legend className="text-lg font-semibold mb-4">
          Contact Information
        </legend>
        
        <div className="space-y-4">
          <Input
            name="name"
            label="Full Name"
            required
            // Enhanced: Real-time validation
            onChange={handleFieldChange}
            error={fieldErrors.name}
            // Advanced: Auto-save drafts
            defaultValue={formData.name}
          />
          
          <Input
            name="email"
            type="email"
            label="Email Address"
            required
            // Enhanced: Format validation
            pattern="[^@\\s]+@[^@\\s]+\\.[^@\\s]+"
            // Advanced: Smart suggestions
            list="email-domains"
          />
        </div>
      </fieldset>
      
      {/* Enhanced: Better UX with JavaScript */}
      <div className="flex gap-3">
        <Button type="submit" disabled={isOffline}>
          {isOffline ? 'Offline - Will Submit Later' : 'Submit'}
        </Button>
        
        <Button type="button" variant="outline" onClick={saveDraft}>
          Save Draft
        </Button>
      </div>
      
      {/* Advanced: PWA features */}
      {isOffline && (
        <div className="p-3 bg-warning/10 border border-warning/20 rounded">
          <p className="text-sm text-warning-foreground">
            You're currently offline. Your form will be submitted when connection is restored.
          </p>
        </div>
      )}
    </form>
  );
}
```

## Device and Context Adaptation

### Responsive Enhancement
Adapt features based on device capabilities:

```tsx
// ✅ RESPONSIVE ENHANCEMENT - Device-appropriate features
function AdaptiveInterface() {
  const [isMobile] = useMediaQuery('(max-width: 768px)');
  const [isTouchDevice] = useMediaQuery('(pointer: coarse)');
  const [hasHover] = useMediaQuery('(hover: hover)');
  
  return (
    <div className="space-y-4">
      {/* Core: Works everywhere */}
      <Card className="p-4">
        <h3 className="font-semibold mb-2">Quick Actions</h3>
        
        <div className={cn(
          "grid gap-2",
          // Enhanced: Better layout on different devices
          isMobile ? "grid-cols-1" : "grid-cols-3"
        )}>
          <Button 
            size={isTouchDevice ? "lg" : "md"}
            className={cn(
              // Advanced: Touch-optimized interactions
              isTouchDevice && "min-h-[44px]"
            )}
          >
            Create New
          </Button>
          
          {/* Enhanced: Show more options on larger screens */}
          {!isMobile && (
            <>
              <Button variant="outline">Import</Button>
              <Button variant="outline">Export</Button>
            </>
          )}
        </div>
        
        {/* Advanced: Hover enhancements for capable devices */}
        {hasHover && (
          <div className="mt-4 opacity-0 group-hover:opacity-100 transition-opacity">
            <p className="text-sm text-muted-foreground">
              Hover for additional options
            </p>
          </div>
        )}
      </Card>
    </div>
  );
}
```

### Network-Aware Enhancement
Adapt to connection quality and data usage preferences:

```tsx
// ✅ NETWORK-AWARE ENHANCEMENT - Adapts to connection quality
function NetworkAwareContent() {
  const [connectionSpeed] = useNetworkStatus();
  const [dataPreference] = useDataPreference();
  
  const shouldLoadImages = connectionSpeed !== 'slow' && dataPreference !== 'reduced';
  const shouldUseAnimations = connectionSpeed === 'fast' && dataPreference !== 'reduced';
  
  return (
    <div className="space-y-6">
      <Card className="p-6">
        {/* Core: Always load essential content */}
        <h2 className="text-xl font-semibold mb-2">
          Product Updates
        </h2>
        
        <p className="text-muted-foreground mb-4">
          Stay informed about new features and improvements
        </p>
        
        {/* Enhanced: Load media based on connection */}
        {shouldLoadImages ? (
          <img 
            src="/api/images/feature-preview.jpg"
            alt="New feature preview"
            className="w-full rounded mb-4"
            loading="lazy"
          />
        ) : (
          <div className="bg-accent/20 p-8 text-center rounded mb-4">
            <p className="text-sm text-muted-foreground">
              Image not loaded to save data
              <Button variant="ghost" size="sm" className="ml-2">
                Load anyway
              </Button>
            </p>
          </div>
        )}
        
        {/* Advanced: Rich animations for fast connections */}
        <Button 
          variant="primary"
          className={cn(
            shouldUseAnimations && "transition-all duration-300 hover:shadow-lg"
          )}
        >
          Learn More
        </Button>
      </Card>
    </div>
  );
}
```

## Accessibility-First Enhancement

### Progressive Accessibility Features
Build accessibility into every enhancement layer:

```tsx
// ✅ ACCESSIBILITY-FIRST ENHANCEMENT - Universal access at every layer
function AccessibleProgressiveComponent() {
  const [prefersReducedMotion] = usePreferenceQuery('prefers-reduced-motion');
  const [prefersHighContrast] = usePreferenceQuery('prefers-contrast');
  const [screenReaderActive] = useScreenReaderDetection();
  
  return (
    <div className="space-y-4">
      {/* Core: Semantic HTML with proper ARIA */}
      <section 
        aria-labelledby="actions-heading"
        className={cn(
          "p-4 border rounded",
          // Enhanced: Respect user preferences
          prefersHighContrast && "border-2 border-foreground"
        )}
      >
        <h2 id="actions-heading" className="text-lg font-semibold mb-3">
          Available Actions
        </h2>
        
        <div className="grid grid-cols-2 gap-3">
          <Button
            aria-describedby="save-description"
            className={cn(
              // Advanced: Animation respects motion preferences
              !prefersReducedMotion && "hover:scale-105 transition-transform"
            )}
          >
            Save Changes
          </Button>
          
          {/* Enhanced: Additional context for screen readers */}
          <div 
            id="save-description" 
            className={screenReaderActive ? "sr-only" : "hidden"}
          >
            Saves your current changes to the server
          </div>
          
          <Button
            variant="destructive"
            aria-describedby="delete-warning"
          >
            Delete Item
          </Button>
          
          <div 
            id="delete-warning" 
            className={screenReaderActive ? "sr-only" : "hidden"}
          >
            Warning: This action cannot be undone
          </div>
        </div>
        
        {/* Advanced: Enhanced feedback for assistive technology */}
        <div 
          role="status" 
          aria-live="polite" 
          aria-atomic="true"
          className="sr-only"
        >
          {/* Dynamic status announcements */}
        </div>
      </section>
    </div>
  );
}
```

## Enhancement Anti-Patterns

### JavaScript Dependence
Building core functionality that requires JavaScript:

```tsx
// ❌ JAVASCRIPT-DEPENDENT - Fails without JavaScript
function BrokenWithoutJS() {
  const [isOpen, setIsOpen] = useState(false);
  
  // This form won't work if JavaScript fails to load
  return (
    <div>
      <button onClick={() => setIsOpen(!isOpen)}>
        Toggle Form
      </button>
      
      {isOpen && (
        <form onSubmit={(e) => {
          e.preventDefault();
          // Only works with JavaScript
          handleSubmit(formData);
        }}>
          <input type="text" name="name" />
          <button type="submit">Submit</button>
        </form>
      )}
    </div>
  );
}

// ✅ PROGRESSIVE - Works without JavaScript, enhanced with it
function ProgressiveForm() {
  const [isEnhanced, setIsEnhanced] = useState(false);
  
  useEffect(() => {
    // Enhancement only activates after JavaScript loads
    setIsEnhanced(true);
  }, []);
  
  return (
    <div>
      {/* Core: Form visible by default, works without JS */}
      <form 
        action="/api/submit" 
        method="POST"
        onSubmit={isEnhanced ? handleEnhancedSubmit : undefined}
      >
        <input type="text" name="name" required />
        <button type="submit">
          {isEnhanced ? 'Submit (Enhanced)' : 'Submit'}
        </button>
      </form>
    </div>
  );
}
```

### All-or-Nothing Features
Features that only work in perfect conditions:

```tsx
// ❌ ALL-OR-NOTHING - Works perfectly or not at all
function BrittleComponent() {
  if (!navigator.geolocation || !window.fetch || !window.IntersectionObserver) {
    return <div>Sorry, your browser isn't supported</div>;
  }
  
  // Complex feature that fails completely if any part breaks
  return <AdvancedLocationAwareInterface />;
}

// ✅ GRACEFUL DEGRADATION - Each feature layer works independently
function RobustComponent() {
  const [hasGeolocation] = useGeolocationSupport();
  const [hasIntersectionObserver] = useIntersectionObserverSupport();
  
  return (
    <div>
      {/* Core: Always works */}
      <BasicInterface />
      
      {/* Enhanced: Add location if available */}
      {hasGeolocation && <LocationFeatures />}
      
      {/* Advanced: Add performance optimizations if supported */}
      {hasIntersectionObserver && <LazyLoadingImages />}
    </div>
  );
}
```

## Practical Application Guidelines

### Enhancement Strategy Checklist
Before adding any enhancement layer:

- [ ] **Core functionality works** without the enhancement
- [ ] **Accessibility maintained** at every layer
- [ ] **Performance considered** - enhancements don't slow down core
- [ ] **User preferences respected** - motion, data usage, contrast
- [ ] **Graceful degradation** - failures don't break the experience
- [ ] **Progressive disclosure** - complexity revealed only when beneficial

### Enhancement Testing Framework
Test your progressive enhancements:

1. **Core Layer Test** - Disable JavaScript, test core functionality
2. **Network Test** - Test on slow connections, simulate failures
3. **Device Test** - Test on various devices and screen sizes
4. **Accessibility Test** - Test with screen readers, keyboard-only
5. **Preference Test** - Test with reduced motion, high contrast, data saver
6. **Feature Support Test** - Test on browsers with different capabilities

---

**Remember: Start with what works for everyone, then layer on what delights those who can experience it.**