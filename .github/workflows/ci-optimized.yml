name: CI Optimized

on:
  pull_request:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.changeset/**'
      - 'LICENSE'
      - '.gitignore'
      - '.env.example'

# Cancel in-progress runs for the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  TURBO_TOKEN: ${{ secrets.TURBO_TOKEN }}
  TURBO_TEAM: ${{ vars.TURBO_TEAM }}

jobs:
  # Quick failure detection - run in parallel
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.filter.outputs.packages }}
      apps: ${{ steps.filter.outputs.apps }}
      website: ${{ steps.filter.outputs.website }}
      api: ${{ steps.filter.outputs.api }}
      ui: ${{ steps.filter.outputs.ui }}
      shared: ${{ steps.filter.outputs.shared }}
      tokens: ${{ steps.filter.outputs.tokens }}
      needs-playwright: ${{ steps.filter.outputs.needs-playwright }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            packages:
              - 'packages/**'
            apps:
              - 'apps/**'
            website:
              - 'apps/website/**'
            api:
              - 'apps/api/**'
            ui:
              - 'packages/ui/**'
            shared:
              - 'packages/shared/**'
            tokens:
              - 'packages/design-tokens/**'
            needs-playwright:
              - 'apps/website/**'
              - 'packages/ui/**'

  # Fast syntax check - fail early
  biome-check:
    name: Biome Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Biome
        uses: biomejs/setup-biome@v2
        with:
          version: 2.2.2

      - name: Run Biome check
        run: biome check --diagnostic-level=error --no-errors-on-unmatched

  # Type checking - can run in parallel with other jobs
  typecheck:
    name: TypeScript Check
    runs-on: ubuntu-latest
    needs: [detect-changes]
    strategy:
      matrix:
        package:
          - website
          - api
          - ui
          - shared
          - design-tokens
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Restore pnpm store
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules/.cache
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Restore TypeScript cache
        uses: actions/cache@v4
        with:
          path: |
            **/.tsbuildinfo
            **/tsconfig.tsbuildinfo
          key: ${{ runner.os }}-tsc-${{ matrix.package }}-${{ hashFiles('**/tsconfig.json', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-tsc-${{ matrix.package }}-

      - name: Run TypeScript check for ${{ matrix.package }}
        run: |
          if [ "${{ matrix.package }}" = "website" ] || [ "${{ matrix.package }}" = "api" ]; then
            pnpm --filter ${{ matrix.package }} type-check || pnpm --filter ${{ matrix.package }} typecheck
          else
            pnpm --filter @rafters/${{ matrix.package }} type-check || pnpm --filter @rafters/${{ matrix.package }} typecheck
          fi

  # Build jobs - with caching and parallelization
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [detect-changes, biome-check]
    strategy:
      matrix:
        include:
          - package: shared
            path: packages/shared
            cache-key: shared
          - package: design-tokens
            path: packages/design-tokens
            cache-key: tokens
          - package: ui
            path: packages/ui
            cache-key: ui
          - package: website
            path: apps/website
            cache-key: website
          - package: api
            path: apps/api
            cache-key: api
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Restore pnpm store
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules/.cache
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Restore build cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ matrix.path }}/dist
            ${{ matrix.path }}/.next
            ${{ matrix.path }}/.astro
            ${{ matrix.path }}/build
          key: ${{ runner.os }}-build-${{ matrix.cache-key }}-${{ hashFiles(format('{0}/**/*.{ts,tsx,js,jsx}', matrix.path), '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ matrix.cache-key }}-

      - name: Build ${{ matrix.package }}
        run: |
          if [ "${{ matrix.package }}" = "website" ] || [ "${{ matrix.package }}" = "api" ]; then
            pnpm --filter ${{ matrix.package }} build
          else
            pnpm --filter @rafters/${{ matrix.package }} build
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.cache-key }}
          path: |
            ${{ matrix.path }}/dist
            ${{ matrix.path }}/.next
            ${{ matrix.path }}/.astro
            ${{ matrix.path }}/build
          retention-days: 1

  # Unit tests - run in parallel
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [detect-changes, biome-check]
    strategy:
      matrix:
        package:
          - website
          - api
          - ui
          - shared
          - design-tokens
          - color-utils
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Restore pnpm store
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules/.cache
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Run unit tests for ${{ matrix.package }}
        run: |
          if [ "${{ matrix.package }}" = "website" ] || [ "${{ matrix.package }}" = "api" ]; then
            pnpm --filter ${{ matrix.package }} test:run || pnpm --filter ${{ matrix.package }} test
          else
            pnpm --filter @rafters/${{ matrix.package }} test:run || pnpm --filter @rafters/${{ matrix.package }} test
          fi

  # Playwright tests - only when needed
  playwright-tests:
    name: Playwright Tests
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: needs.detect-changes.outputs.needs-playwright == 'true'
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Restore pnpm store
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules/.cache
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json', '**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright browsers if needed
        run: |
          if [ ! -d ~/.cache/ms-playwright ]; then
            pnpm --filter website exec playwright install --with-deps
          fi

      - name: Download website build
        uses: actions/download-artifact@v4
        with:
          name: build-website
          path: apps/website

      - name: Run Playwright component tests
        run: pnpm --filter website test:component

      - name: Run Playwright E2E tests
        run: pnpm --filter website test:e2e

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: apps/website/playwright-report
          retention-days: 7

  # Changeset check - can run in parallel
  changeset-check:
    name: Changeset Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - run: git fetch origin main:main

      - uses: pnpm/action-setup@v4
        with:
          version: 10

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install minimal dependencies
        run: pnpm install --frozen-lockfile --filter changesets-cli

      - name: Check for changesets
        run: |
          if [ -z "$(ls -A .changeset/ 2>/dev/null | grep -v README.md | grep -v config.json)" ]; then
            echo "::warning::No changeset found. If this PR includes changes that should trigger a release, please add a changeset by running 'pnpm changeset' and committing the result."
          else
            echo "Changeset found"
            pnpm changeset:check
          fi

  # Final status check - lightweight
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [biome-check, typecheck, build, unit-tests, changeset-check]
    if: always()
    steps:
      - name: Check CI Status
        run: |
          if [ "${{ contains(needs.*.result, 'failure') }}" = "true" ]; then
            echo "CI failed"
            exit 1
          else
            echo "CI passed"
          fi